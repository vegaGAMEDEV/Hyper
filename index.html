<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nexus</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: #2d3436;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .setup-panel {
            padding: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        input, button {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        input {
            background: #f8f9fa;
        }

        button {
            background: #00b894;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        button:hover {
            background: #00a382;
        }

        button:disabled {
            background: #b2bec3;
            cursor: not-allowed;
        }

        .qr-section {
            text-align: center;
            padding: 20px;
            background: #f1f2f6;
            display: none;
        }

        #qrcode {
            margin: 15px auto;
            padding: 10px;
            background: white;
            border-radius: 10px;
            display: inline-block;
        }

        .chat-container {
            display: none;
            flex-direction: column;
            height: 500px;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 12px;
            max-width: 80%;
        }

        .my-message {
            background: #74b9ff;
            color: white;
            margin-left: auto;
        }

        .their-message {
            background: #dfe6e9;
            color: #2d3436;
        }

        .system-message {
            background: #ffeaa7;
            color: #2d3436;
            text-align: center;
            margin: 10px auto;
            max-width: 90%;
        }

        .message-input {
            padding: 15px;
            background: white;
            border-top: 2px solid #eee;
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
        }

        .message-input button {
            width: 60px;
        }

        .status {
            text-align: center;
            padding: 10px;
            background: #2d3436;
            color: white;
            font-size: 14px;
        }

        .step-number {
            background: #00b894;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        .instructions {
            background: #fff9e6;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffd32a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí¨nexus</h1>
            <p>–û–±—â–∞–π—Ç–µ—Å—å –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤!</p>
        </div>

        <div class="setup-panel" id="setupPanel">
            <div class="input-group">
                <label>üìõ –í–∞—à–µ –∏–º—è:</label>
                <input type="text" id="myName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" value="–Ø">
            </div>

            <div class="instructions">
                <h3>üéØ –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è:</h3>
                <p><span class="step-number">1</span> –í–≤–µ–¥–∏—Ç–µ –∏–º—è</p>
                <p><span class="step-number">2</span> –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å —á–∞—Ç"</p>
                <p><span class="step-number">3</span> –î—Ä—É–≥–æ–π —á–µ–ª–æ–≤–µ–∫ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR-–∫–æ–¥</p>
                <p><span class="step-number">4</span> –ì–æ—Ç–æ–≤–æ! –ú–æ–∂–Ω–æ –æ–±—â–∞—Ç—å—Å—è</p>
            </div>

            <button onclick="createChat()" id="createBtn">üîÑ –°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
            
            <div class="input-group">
                <label>üîó –ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</label>
                <input type="text" id="connectionCode" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ —Å—é–¥–∞">
                <button onclick="joinChat()" style="margin-top: 10px; background: #6c5ce7;">‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
        </div>

        <div class="qr-section" id="qrSection">
            <h3>üì≤ –ü—É—Å—Ç—å –¥—Ä—É–≥ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç –∫–æ–¥:</h3>
            <div id="qrcode"></div>
            <p>–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥:</p>
            <input type="text" id="connectionString" readonly>
            <button onclick="copyCode()" style="background: #fd79a8;">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
            <button onclick="startChat()" style="background: #00b894;">üí¨ –ù–∞—á–∞—Ç—å —á–∞—Ç</button>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="messages" id="messages">
                <div class="message system-message">
                    üí´ –ß–∞—Ç —Å–æ–∑–¥–∞–Ω! –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                </div>
            </div>
            <div class="message-input">
                <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                <button onclick="sendMessage()" disabled id="sendBtn">‚û§</button>
            </div>
        </div>

        <div class="status" id="status">‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
    </div>

    <script>
        let peerConnection = null;
        let dataChannel = null;
        let myName = '';
        let isCreator = false;

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è P2P
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        function createChat() {
            myName = document.getElementById('myName').value.trim();
            if (!myName) {
                alert('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è!');
                return;
            }

            isCreator = true;
            setupConnection();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º QR-–∫–æ–¥
            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('qrSection').style.display = 'block';
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            const connectionCode = generateConnectionCode();
            document.getElementById('connectionString').value = connectionCode;
            
            // –°–æ–∑–¥–∞–µ–º QR-–∫–æ–¥
            QRCode.toCanvas(document.getElementById('qrcode'), connectionCode, {
                width: 200,
                height: 200,
                margin: 1
            });
            
            updateStatus('üîÑ –û–∂–∏–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
        }

        function joinChat() {
            myName = document.getElementById('myName').value.trim();
            const connectionCode = document.getElementById('connectionCode').value.trim();
            
            if (!myName) {
                alert('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è!');
                return;
            }
            
            if (!connectionCode) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è!');
                return;
            }

            isCreator = false;
            setupConnection();
            connectToPeer(connectionCode);
        }

        function setupConnection() {
            // –°–æ–∑–¥–∞–µ–º P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            peerConnection = new RTCPeerConnection(config);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            peerConnection.oniceconnectionstatechange = () => {
                updateStatus(getStatusEmoji() + ' ' + peerConnection.iceConnectionState);
            };

            // –ï—Å–ª–∏ –º—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å —á–∞—Ç–∞, —Å–æ–∑–¥–∞–µ–º –∫–∞–Ω–∞–ª –¥–∞–Ω–Ω—ã—Ö
            if (isCreator) {
                dataChannel = peerConnection.createDataChannel('chat');
                setupDataChannel();
            } else {
                // –ï—Å–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è, –∂–¥–µ–º –∫–∞–Ω–∞–ª –¥–∞–Ω–Ω—ã—Ö
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel();
                };
            }
        }

        function setupDataChannel() {
            dataChannel.onopen = () => {
                enableChat();
                addMessage('–°–∏—Å—Ç–µ–º–∞', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'system');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
                sendData({
                    type: 'join',
                    name: myName
                });
            };

            dataChannel.onclose = () => {
                disableChat();
                addMessage('–°–∏—Å—Ç–µ–º–∞', '‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', 'system');
            };

            dataChannel.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    console.log('–û—à–∏–±–∫–∞:', e);
                }
            };
        }

        async function connectToPeer(offerData) {
            try {
                const offer = JSON.parse(offerData);
                await peerConnection.setRemoteDescription(offer);
                
                // –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ - —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞)
                // –ó–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –∫–∞–Ω–∞–ª
                sendData({
                    type: 'answer',
                    answer: answer
                });
                
                updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ!');
                showChat();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'join':
                    addMessage('–°–∏—Å—Ç–µ–º–∞', `üë§ ${data.name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è`, 'system');
                    break;
                case 'message':
                    addMessage(data.name, data.text, 'their');
                    break;
                case 'answer':
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –Ω–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                    peerConnection.setRemoteDescription(data.answer)
                        .then(() => {
                            updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ!');
                            showChat();
                        });
                    break;
            }
        }

        function sendData(data) {
            if (dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(JSON.stringify(data));
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (text && dataChannel) {
                sendData({
                    type: 'message',
                    name: myName,
                    text: text
                });
                
                addMessage(myName, text, 'my');
                input.value = '';
            }
        }

        function addMessage(name, text, type) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${
                type === 'my' ? 'my-message' : 
                type === 'their' ? 'their-message' : 'system-message'
            }`;
            
            const time = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `
                <strong>${name}</strong> <small>${time}</small>
                <br>${text}
            `;
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function generateConnectionCode() {
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            return peerConnection.localDescription ? 
                JSON.stringify(peerConnection.localDescription) : 
                'waiting...';
        }

        function copyCode() {
            const codeInput = document.getElementById('connectionString');
            codeInput.select();
            document.execCommand('copy');
            alert('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –¥—Ä—É–≥—É.');
        }

        function startChat() {
            showChat();
        }

        function showChat() {
            document.getElementById('qrSection').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'flex';
        }

        function enableChat() {
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('messageInput').focus();
        }

        function disableChat() {
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
        }

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        function getStatusEmoji() {
            if (!peerConnection) return '‚ùå';
            
            switch (peerConnection.iceConnectionState) {
                case 'connected': return '‚úÖ';
                case 'connecting': return 'üîÑ';
                case 'disconnected': return '‚ö†Ô∏è';
                case 'failed': return '‚ùå';
                default: return '‚ùì';
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –∏–º–µ–Ω–∏
        document.getElementById('myName').focus();

        // –ü—Ä–æ—Å—Ç–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–¥–ª—è –¥–µ–º–æ)
        async function generateOffer() {
            if (isCreator && peerConnection) {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                return JSON.stringify(offer);
            }
            return '';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ–≥–¥–∞ –æ–Ω –≥–æ—Ç–æ–≤
        setInterval(() => {
            if (isCreator && peerConnection && peerConnection.localDescription) {
                const code = JSON.stringify(peerConnection.localDescription);
                if (document.getElementById('connectionString').value !== code) {
                    document.getElementById('connectionString').value = code;
                    // –û–±–Ω–æ–≤–ª—è–µ–º QR-–∫–æ–¥
                    QRCode.toCanvas(document.getElementById('qrcode'), code, {
                        width: 200,
                        height: 200
                    });
                }
            }
        }, 1000);
    </script>
</body>
</html>